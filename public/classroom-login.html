<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Classroom Login | BBCC</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Tahoma}
body{
min-height:100vh;
display:flex;
justify-content:center;
align-items:center;
background:linear-gradient(135deg,#1e3c72,#2a5298)
}
.box{
background:#fff;
width:100%;
max-width:420px;
padding:30px;
border-radius:14px;
box-shadow:0 15px 35px rgba(0,0,0,.3)
}
h2{text-align:center;color:#1e3c72;margin-bottom:5px}
p{text-align:center;color:#666;margin-bottom:20px;font-size:14px}

.group{margin-bottom:15px}
label{font-size:14px;font-weight:600;color:#333}
.input{
position:relative
}
.input i{
position:absolute;
left:12px;
top:50%;
transform:translateY(-50%);
color:#777
}
.input input{
width:100%;
padding:12px 12px 12px 40px;
border-radius:8px;
border:2px solid #ddd;
font-size:15px
}
.input input:focus{outline:none;border-color:#1e3c72}

button{
width:100%;
padding:13px;
border:none;
border-radius:8px;
background:#1e3c72;
color:#fff;
font-size:16px;
font-weight:600;
cursor:pointer
}
button:disabled{background:#999}

.msg{
margin-top:15px;
padding:10px;
border-radius:8px;
font-size:14px;
display:none
}
.error{background:#fee2e2;color:#b91c1c;display:block}
.success{background:#dcfce7;color:#166534;display:block}

.type{
margin-top:15px;
font-size:13px;
display:none
}
.badge{
padding:4px 10px;
border-radius:20px;
font-weight:700;
font-size:12px;
color:#fff
}
.student{background:#3b82f6}
.teacher{background:#10b981}
.admin{background:#dc2626}
</style>
</head>

<body>

<div class="box">
<h2>üîê Classroom Login</h2>
<p>Bal Bharti Coaching Center</p>

<div id="msg" class="msg"></div>

<form id="loginForm">
<div class="group">
<label>User ID</label>
<div class="input">
<i class="fas fa-user"></i>
<input id="userIdInput" required autocomplete="off">
</div>
</div>

<div class="group">
<label>Password</label>
<div class="input">
<i class="fas fa-lock"></i>
<input id="passwordInput" type="password" required autocomplete="off">
</div>
</div>

<button id="loginBtn">Join Classroom</button>
</form>

<div id="typeBox" class="type">
Detected:
<span id="badge" class="badge"></span>
<span id="userName"></span>
</div>
</div>

<script>
const form = document.getElementById("loginForm");
const msg = document.getElementById("msg");
const btn = document.getElementById("loginBtn");

const userIdInput = document.getElementById("userIdInput");
const passwordInput = document.getElementById("passwordInput");

const typeBox = document.getElementById("typeBox");
const badge = document.getElementById("badge");
const userNameSpan = document.getElementById("userName");

function show(text,type){
msg.textContent=text;
msg.className="msg "+type;
msg.style.display="block";
}

function detectType(id){
id=id.toUpperCase();
if(id.startsWith("ADM")) return "admin";
if(id.startsWith("TCH")||id.startsWith("TEA")) return "teacher";
return "student";
}

function showType(type,name=""){
typeBox.style.display="block";
badge.className="badge "+type;
badge.textContent=type.toUpperCase();
userNameSpan.textContent=name?(" ‚Ä¢ "+name):"";
}

form.addEventListener("submit",async e=>{
e.preventDefault();
btn.disabled=true;

const userId = userIdInput.value.trim();
const password = passwordInput.value.trim();
const guessedType = detectType(userId);

showType(guessedType);

try{
const res = await fetch(
`/api/classroom/verify?userId=${encodeURIComponent(userId)}&password=${encodeURIComponent(password)}&userType=${guessedType}`
);
const data = await res.json();

if(!data.success){
show("Invalid ID or Password","error");
btn.disabled=false;
return;
}

showType(data.userType,data.user.name);

let roomId = null;

if(data.userType !== "student"){
const r = await fetch("/api/classroom/create",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
teacherId:userId,
className:data.user.name+"'s Class"
})
});
const rd = await r.json();
roomId = rd.roomId;
}else{
const r = await fetch("/api/classroom/active-rooms");
const rd = await r.json();
if(!rd.rooms || !rd.rooms.length){
show("Class not started yet. Wait for teacher.","error");
btn.disabled=false;
return;
}
roomId = rd.rooms[0].roomId;
}

show("Login successful. Joining classroom‚Ä¶","success");

setTimeout(()=>{
window.location.href =
`/classroom.html?userId=${encodeURIComponent(userId)}&userType=${data.userType}&name=${encodeURIComponent(data.user.name)}&roomId=${roomId}`;
},700);

}catch(err){
show("Server error. Try again later.","error");
btn.disabled=false;
}
});
</script>

</body>
</html>
