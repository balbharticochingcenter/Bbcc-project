<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f4f6f9;margin:0}
header{background:#1e293b;color:#fff;padding:15px;font-size:20px}
.container{padding:20px}

select,input,button{
    padding:8px;
    margin:5px;
}

button{cursor:pointer}

.card{
    background:#fff;
    padding:15px;
    margin-bottom:10px;
    border-radius:6px;
    display:flex;
    gap:15px;
    align-items:center;
}

.card img{
    width:80px;height:80px;border-radius:50%;object-fit:cover;
}

.actions button{
    margin-right:5px;
}

.hidden{display:none}

.modal{
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,0.5);
    display:none;
    justify-content:center;
    align-items:center;
}

.modal-content{
    background:#fff;
    padding:20px;
    width:90%;
    max-width:600px;
    max-height:90%;
    overflow:auto;
}
</style>
</head>

<body>

<header>üéì Student Dashboard</header>

<div class="container">

<!-- FILTER -->
<select id="classSelect"></select>
<select id="batchSelect"></select>

<button onclick="loadStudents()">üîµ Load</button>
<button onclick="openPromote()">üü¢ Promote Next Class</button>

<hr>

<!-- STUDENT LIST -->
<div id="studentList"></div>

</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
<div class="modal-content">
<h3>Edit Student</h3>

<input id="e_name" placeholder="Student Name">
<input id="e_class" placeholder="Class">
<input id="e_batch" placeholder="Batch Year">
<input id="e_fees" placeholder="Fees">
<input id="e_doj" placeholder="Date of Joining">

<br><br>
<button onclick="updateStudent()">‚úÖ Update</button>
<button onclick="closeModal()">‚ùå Close</button>
</div>
</div>

<!-- PROMOTE MODAL -->
<div class="modal" id="promoteModal">
<div class="modal-content">
<h3>Promote Students</h3>

<input id="p_class" placeholder="New Class">
<input id="p_batch" placeholder="New Batch Year">
<input id="p_fees" placeholder="New Fees">

<br><br>
<button onclick="promoteStudents()">üü¢ Promote</button>
<button onclick="closePromote()">‚ùå Close</button>
</div>
</div>

<!-- FEES MODAL -->
<div class="modal" id="feesModal">
<div class="modal-content">
<h3>Fees Tracker</h3>
<div id="feesData"></div>
<button onclick="closeFees()">‚ùå Close</button>
</div>
</div>

<script>
let students = [];
let selectedStudents = [];
let editId = "";

/* LOAD CLASS & BATCH */
async function init(){
    const cls = await fetch('/api/get-all-classes').then(r=>r.json());
    classSelect.innerHTML = cls.map(c=>`<option>${c}</option>`).join('');

    batchSelect.innerHTML = `
        <option>2023</option>
        <option>2024</option>
        <option>2025</option>`;
}
init();

/* LOAD STUDENTS */
async function loadStudents(){
    const c = classSelect.value;
    const b = batchSelect.value;

    const res = await fetch('/api/get-students');
    const all = await res.json();

    students = all.filter(s=>s.student_class===c && s.batch_year===b);
    renderStudents();
}

/* RENDER */
function renderStudents(){
    studentList.innerHTML = "";
    selectedStudents = [];

    students.forEach(s=>{
        const div = document.createElement('div');
        div.className="card";
        div.innerHTML=`
        <input type="checkbox" onchange="toggleSelect('${s.student_id}')">
        <img src="${s.photo||'https://via.placeholder.com/80'}">
        <div>
            <b>${s.student_name}</b><br>
            ID: ${s.student_id}<br>
            Roll: ${s.roll_number||'-'}<br>
            DOJ: ${s.joining_date||'-'}<br>
            Class: ${s.student_class}<br>
            Batch: ${s.batch_year}<br>
            Fees: ‚Çπ${s.fees}
        </div>
        <div class="actions">
            <button onclick="editStudent('${s.student_id}')">‚úè Edit</button>
            <button onclick="openFees('${s.student_id}')">üí∞ Fees</button>
        </div>`;
        studentList.appendChild(div);
    });
}

/* SELECT */
function toggleSelect(id){
    if(selectedStudents.includes(id))
        selectedStudents=selectedStudents.filter(i=>i!==id);
    else selectedStudents.push(id);
}

/* EDIT */
function editStudent(id){
    const s = students.find(x=>x.student_id===id);
    editId = id;

    e_name.value = s.student_name;
    e_class.value = s.student_class;
    e_batch.value = s.batch_year;
    e_fees.value = s.fees;
    e_doj.value = s.joining_date;

    editModal.style.display="flex";
}

async function updateStudent(){
    await fetch('/api/update-student-data',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            student_id:editId,
            student_name:e_name.value,
            student_class:e_class.value,
            batch_year:e_batch.value,
            fees:e_fees.value,
            joining_date:e_doj.value
        })
    });
    alert("Updated");
    closeModal();
    loadStudents();
}

function closeModal(){editModal.style.display="none";}

/* PROMOTE */
function openPromote(){
    if(selectedStudents.length===0){
        alert("Select students first");
        return;
    }
    promoteModal.style.display="flex";
}

async function promoteStudents(){
    await fetch('/api/student-dashboard/bulk-promote',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            student_ids:selectedStudents,
            new_class:p_class.value,
            new_batch:p_batch.value,
            new_fees:p_fees.value
        })
    });
    alert("Promoted");
    closePromote();
}

function closePromote(){promoteModal.style.display="none";}

/* FEES */
async function openFees(id){
    const res = await fetch('/api/student-dashboard/fees/'+id);
    const data = await res.json();

    feesData.innerHTML=`
    <b>Total Fees:</b> ‚Çπ${data.fee_summary.total_fees}<br>
    <b>Total Paid:</b> ‚Çπ${data.fee_summary.total_paid}<br>
    <b>Due:</b> ‚Çπ${data.fee_summary.due_amount}<hr>
    ${data.payment_history.map(p=>`
        Month:${p.month}/${p.year} |
        Paid:‚Çπ${p.amount} |
        Date:${new Date(p.payment_date).toLocaleDateString()}
    `).join('<br>')}
    `;

    feesModal.style.display="flex";
}
function closeFees(){feesModal.style.display="none";}
</script>

</body>
</html>
