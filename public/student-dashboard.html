<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management Dashboard</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary-color: #4e73df; --secondary-color: #858796; }
        body { background-color: #f8f9fc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        .main-card { border: none; border-radius: 15px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); }
        .table-container { background: white; border-radius: 15px; padding: 20px; }
        
        .student-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; }
        .btn-edit { background-color: #f6c23e; color: white; border: none; }
        .btn-edit:hover { background-color: #dda20a; color: white; }
        
        .modal-header { background: var(--primary-color); color: white; border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .preview-img-container { text-align: center; margin-bottom: 15px; }
        #modal_photo_preview { width: 100px; height: 100px; border-radius: 10px; object-fit: cover; border: 3px solid #eee; }
        
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-active { background: #e1f6e5; color: #2ecc71; }
    </style>
</head>
<body>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 px-3">
        <h2 class="text-dark fw-bold"><i class="fas fa-user-graduate me-2"></i>Student Management</h2>
        <div class="d-flex gap-2">
            <input type="text" id="studentSearch" class="form-control" placeholder="Search by name or ID..." onkeyup="filterStudents()">
            <button class="btn btn-primary shadow-sm"><i class="fas fa-download"></i></button>
        </div>
    </div>

    <div class="main-card card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Photo</th>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Class & Batch</th>
                            <th>Monthly Fees</th>
                            <th>DOJ</th>
                            <th>Password</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="studentList">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none;">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>Update Student Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateStudentForm">
                <div class="modal-body p-4">
                    <input type="hidden" id="edit_db_id">
                    
                    <div class="preview-img-container">
                        <img id="modal_photo_preview" src="" alt="Preview">
                        <div class="mt-2">
                            <input type="text" class="form-control form-control-sm" id="edit_photo" placeholder="Paste Photo URL here">
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Student Name</label>
                            <input type="text" class="form-control" id="edit_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Login Password</label>
                            <input type="text" class="form-control" id="edit_pass" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Class</label>
                            <input type="text" class="form-control" id="edit_class" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Batch Year</label>
                            <input type="text" class="form-control" id="edit_batch" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Monthly Fees (₹)</label>
                            <input type="number" class="form-control" id="edit_fees" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Date of Joining</label>
                            <input type="date" class="form-control" id="edit_doj">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Status</label>
                            <select class="form-select" id="edit_status">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let allStudents = [];
    const editModal = new bootstrap.Modal(document.getElementById('editStudentModal'));

    // 1. Fetch Students from Server
    async function loadStudents() {
        try {
            const response = await fetch('/api/get-students');
            allStudents = await response.json();
            displayStudents(allStudents);
        } catch (error) {
            console.error("Error fetching students:", error);
        }
    }

    // 2. Display Students in Table
    function displayStudents(data) {
        const listBody = document.getElementById('studentList');
        listBody.innerHTML = '';

        data.forEach(student => {
            listBody.innerHTML += `
                <tr>
                    <td class="ps-4">
                        <img src="${student.photo || 'https://via.placeholder.com/150'}" class="student-img shadow-sm">
                    </td>
                    <td><span class="fw-bold text-primary">${student.student_id}</span></td>
                    <td>
                        <div class="fw-bold text-dark">${student.student_name}</div>
                        <small class="text-muted">${student.mobile || 'No Mobile'}</small>
                    </td>
                    <td>
                        <div>${student.student_class}</div>
                        <span class="badge bg-light text-dark border">${student.batch_year}</span>
                    </td>
                    <td><span class="fw-bold text-success">₹${student.fees}</span></td>
                    <td>${student.joining_date || 'N/A'}</td>
                    <td><code>${student.pass}</code></td>
                    <td class="text-center">
                        <button class="btn btn-edit btn-sm" onclick="openEditModal('${student._id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    // 3. Filter Students (Search)
    function filterStudents() {
        const query = document.getElementById('studentSearch').value.toLowerCase();
        const filtered = allStudents.filter(s => 
            s.student_name.toLowerCase().includes(query) || 
            s.student_id.toLowerCase().includes(query)
        );
        displayStudents(filtered);
    }

    // 4. Open Modal and Fill Data
    function openEditModal(mongoId) {
        const s = allStudents.find(item => item._id === mongoId);
        if(!s) return;

        document.getElementById('edit_db_id').value = s._id;
        document.getElementById('edit_name').value = s.student_name;
        document.getElementById('edit_pass').value = s.pass;
        document.getElementById('edit_class').value = s.student_class;
        document.getElementById('edit_batch').value = s.batch_year;
        document.getElementById('edit_fees').value = s.fees;
        document.getElementById('edit_doj').value = s.joining_date || '';
        document.getElementById('edit_photo').value = s.photo || '';
        document.getElementById('modal_photo_preview').src = s.photo || 'https://via.placeholder.com/150';
        document.getElementById('edit_status').value = s.current_status || 'Active';

        editModal.show();
    }

    // 5. Submit Updated Data
    document.getElementById('updateStudentForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit_db_id').value;
        
        const updatedInfo = {
            student_name: document.getElementById('edit_name').value,
            pass: document.getElementById('edit_pass').value,
            student_class: document.getElementById('edit_class').value,
            batch_year: document.getElementById('edit_batch').value,
            fees: document.getElementById('edit_fees').value,
            joining_date: document.getElementById('edit_doj').value,
            photo: document.getElementById('edit_photo').value,
            current_status: document.getElementById('edit_status').value
        };

        try {
            const res = await fetch(`/api/update-student/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedInfo)
            });

            if (res.ok) {
                alert("✅ Success: Student updated!");
                editModal.hide();
                loadStudents(); // Refresh data
            }
        } catch (err) {
            alert("❌ Error updating student");
        }
    };

    // Auto-update preview image when URL is pasted
    document.getElementById('edit_photo').oninput = function() {
        document.getElementById('modal_photo_preview').src = this.value || 'https://via.placeholder.com/150';
    };

    // Start
    loadStudents();
</script>

</body>
</html>
