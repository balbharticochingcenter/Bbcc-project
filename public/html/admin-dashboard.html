<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Admin Panel | BBCC</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-left"><img src="/assets/logo.png" alt="Logo" class="logo"></div>
        <div class="nav-center"><h1 class="glow-text">BBCC Portal Control</h1></div>
        <div class="nav-right">
            <span id="adminDisplayName">Admin</span>
            <button class="logout-mini" onclick="logout()"><i class="fa fa-sign-out-alt"></i></button>
        </div>
    </nav>

    <div class="main-menu">
        <button class="menu-btn" onclick="openModal('regModal')"><i class="fa fa-user-plus"></i> <span>Registration</span></button>
        <button class="menu-btn" onclick="openModal('updateModal')"><i class="fa fa-user-edit"></i> <span>Update User</span></button>
        <button class="menu-btn" onclick="openModal('commModal')"><i class="fa fa-bullhorn"></i> <span>Communications</span></button>
        <button class="menu-btn" onclick="openModal('teacherModal')"><i class="fa fa-chalkboard-teacher"></i> <span>Teacher Mgmt</span></button>
        <button class="menu-btn" onclick="openModal('studentModal')"><i class="fa fa-user-graduate"></i> <span>Student Mgmt</span></button>
    </div>

    <div class="dashboard-history" style="padding: 20px 5%;">
        <div class="card" style="background: var(--card-bg); padding: 20px; border-radius: 15px;">
            <h3><i class="fa fa-history"></i> Recent Messages History</h3>
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr><th>Type</th><th>Target ID</th><th>Message</th><th>Action</th></tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="regModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('regModal')">&times;</span>
            <h2><i class="fa fa-id-card"></i> User Registration</h2>
            <form id="regForm">
                <div class="modal-grid">
                    <input type="text" id="fname" placeholder="First Name" required>
                    <input type="text" id="mname" placeholder="Middle Name">
                    <input type="text" id="lname" placeholder="Last Name" required>
                    <input type="text" id="regMobile" placeholder="Mobile Number" required>
                    <select id="gender"><option value="Male">Male</option><option value="Female">Female</option></select>
                    <select id="regRole">
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                    </select>
                    <input type="date" id="dob">
                    <input type="email" id="email" placeholder="Email ID">
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <label style="font-size:12px;">Upload Photo (.png/.jpg)</label>
                        <input type="file" id="photoFile" accept="image/*">
                    </div>
                    <input type="number" id="financeAmount" placeholder="Fees/Salary">
                    <div class="id-pass-group">
                        <input type="text" id="regID" placeholder="User ID/Roll No">
                        <input type="text" id="regPass" placeholder="Password">
                        <button type="button" onclick="generateCredentials()">Gen</button>
                    </div>
                </div>
                <button type="submit" class="save-btn">Save to Cloud DB</button>
            </form>
        </div>
    </div>

    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('updateModal')">&times;</span>
            <h2><i class="fa fa-edit"></i> Update User Details</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="searchUpdateID" placeholder="Enter ID to Search (e.g. BBCC1234)">
                <button onclick="fetchUserToEdit()" style="background:var(--primary); color:var(--dark); padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; border:none;">Search User</button>
            </div>
            <form id="editForm" style="display:none;">
                <div class="modal-grid">
                    <input type="text" id="uFname" placeholder="First Name">
                    <input type="text" id="uMname" placeholder="Middle Name">
                    <input type="text" id="uLname" placeholder="Last Name">
                    <input type="text" id="uMobile" placeholder="Mobile Number">
                    <select id="uGender"><option value="Male">Male</option><option value="Female">Female</option></select>
                    <input type="date" id="uDob">
                    <input type="email" id="uEmail" placeholder="Email ID">
                    <input type="number" id="uFinance" placeholder="Fees/Salary">
                    <input type="text" id="uPass" placeholder="Change Password">
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <label style="font-size:12px;">Update Photo (Optional)</label>
                        <input type="file" id="uPhotoFile" accept="image/*">
                    </div>
                </div>
                <button type="submit" class="save-btn">Update to Cloud DB</button>
            </form>
        </div>
    </div>

    <div id="commModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('commModal')">&times;</span>
            <h2><i class="fa fa-broadcast-tower"></i> Send Messages</h2>
            <textarea id="msgBody" placeholder="Write notice here..."></textarea>
            <input type="text" id="targetID" placeholder="Specific ID (Required for Private)">
            <div class="btn-group">
                <button onclick="sendMsg('notice', 'teacher')" class="btn-t">To Teachers</button>
                <button onclick="sendMsg('notice', 'student')" class="btn-s">To Students</button>
                <button onclick="sendMsg('notification', 'private')" class="btn-p">Private (By ID)</button>
            </div>
        </div>
    </div>

    <div id="teacherModal" class="modal wide-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('teacherModal')">&times;</span>
            <div class="modal-header">
                <h2>Teacher Records</h2>
                <div class="filter-box">
                    <input type="text" id="tSearch" placeholder="Search ID..." onkeyup="filterTable('teacher')">
                    <input type="date" id="tStartDate"> to <input type="date" id="tEndDate">
                    <button onclick="filterTable('teacher')" class="btn-s">Filter Date</button>
                </div>
                <button onclick="exportToExcel('teacherTable')" class="excel-btn">Download Excel</button>
            </div>
            <div class="table-scroll">
                <table id="teacherTable">
                    <thead>
                        <tr><th>Photo</th><th>Date</th><th>Name</th><th>ID</th><th>Pass</th><th>Salary</th><th>Contact</th></tr>
                    </thead>
                    <tbody id="tBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="studentModal" class="modal wide-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('studentModal')">&times;</span>
            <div class="modal-header">
                <h2>Student Records</h2>
                <div class="filter-box">
                    <input type="text" id="sSearch" placeholder="Search ID..." onkeyup="filterTable('student')">
                    <input type="date" id="sStartDate"> to <input type="date" id="sEndDate">
                    <button onclick="filterTable('student')" class="btn-s">Filter Date</button>
                </div>
                <button onclick="exportToExcel('studentTable')" class="excel-btn">Download Excel</button>
            </div>
            <div class="table-scroll">
                <table id="studentTable">
                    <thead>
                        <tr><th>Photo</th><th>Date</th><th>Name</th><th>ID</th><th>Pass</th><th>Fees</th><th>Contact</th></tr>
                    </thead>
                    <tbody id="sBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let mainData = [];

        function openModal(id) { document.getElementById(id).style.display = "block"; loadData(); }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }

        async function loadData() {
            const res = await fetch('/api/admin/users');
            mainData = await res.json();
            renderTables(mainData);
            loadHistory();
        }

        function renderTables(data) {
            const tBody = document.getElementById('tBody');
            const sBody = document.getElementById('sBody');
            tBody.innerHTML = ""; sBody.innerHTML = "";
            data.forEach(u => {
                const row = `<tr>
                    <td><img src="${u.profilePhoto}" class="table-img"></td>
                    <td>${new Date(u.joinDate).toLocaleDateString()}</td>
                    <td>${u.fname} ${u.lname}</td>
                    <td><b>${u.username}</b></td>
                    <td>${u.password}</td>
                    <td>₹${u.financeAmount}</td>
                    <td class="action-icons">
                        <a href="tel:${u.mobile}" title="Call"><i class="fa fa-phone"></i></a>
                        <a href="https://wa.me/91${u.mobile}" title="WhatsApp" style="color:#25D366;"><i class="fab fa-whatsapp"></i></a>
                        <a href="sms:${u.mobile}" title="SMS" style="color:#38bdf8;"><i class="fa fa-comment-dots"></i></a>
                    </td>
                </tr>`;
                if(u.role === 'teacher') tBody.innerHTML += row;
                else sBody.innerHTML += row;
            });
        }

        function filterTable(role) {
            const searchID = document.getElementById(role === 'teacher' ? 'tSearch' : 'sSearch').value.toLowerCase();
            const start = document.getElementById(role === 'teacher' ? 'tStartDate' : 'sStartDate').value;
            const end = document.getElementById(role === 'teacher' ? 'tEndDate' : 'sEndDate').value;
            const filtered = mainData.filter(u => {
                const matchID = u.username.toLowerCase().includes(searchID);
                const joinDate = new Date(u.joinDate).toISOString().split('T')[0];
                const matchDate = (start && end) ? (joinDate >= start && joinDate <= end) : true;
                return u.role === role && matchID && matchDate;
            });
            renderFiltered(filtered, role === 'teacher' ? 'tBody' : 'sBody');
        }

        function renderFiltered(data, bodyId) {
            const body = document.getElementById(bodyId);
            body.innerHTML = "";
            data.forEach(u => {
                body.innerHTML += `<tr>
                    <td><img src="${u.profilePhoto}" class="table-img"></td>
                    <td>${new Date(u.joinDate).toLocaleDateString()}</td>
                    <td>${u.fname} ${u.lname}</td>
                    <td><b>${u.username}</b></td>
                    <td>${u.password}</td>
                    <td>₹${u.financeAmount}</td>
                    <td class="action-icons">
                        <a href="tel:${u.mobile}"><i class="fa fa-phone"></i></a>
                        <a href="https://wa.me/91${u.mobile}"><i class="fab fa-whatsapp"></i></a>
                        <a href="sms:${u.mobile}"><i class="fa fa-comment-dots"></i></a>
                    </td>
                </tr>`;
            });
        }

        function convertImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
            });
        }

        document.getElementById('regForm').onsubmit = async (e) => {
            e.preventDefault();
            let photoUrl = "/assets/default-user.png";
            const file = document.getElementById('photoFile').files[0];
            if(file) photoUrl = await convertImage(file);
            const data = {
                username: document.getElementById('regID').value,
                password: document.getElementById('regPass').value,
                fname: document.getElementById('fname').value,
                mname: document.getElementById('mname').value,
                lname: document.getElementById('lname').value,
                mobile: document.getElementById('regMobile').value,
                gender: document.getElementById('gender').value,
                dob: document.getElementById('dob').value,
                email: document.getElementById('email').value,
                role: document.getElementById('regRole').value,
                financeAmount: document.getElementById('financeAmount').value,
                profilePhoto: photoUrl
            };
            const res = await fetch('/api/admin/create-user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) { alert("Registered Successfully!"); closeModal('regModal'); loadData(); }
        };

        // --- UPDATED UPDATE FEATURE ---
        async function fetchUserToEdit() {
            const id = document.getElementById('searchUpdateID').value;
            const user = mainData.find(u => u.username === id);
            if(user) {
                document.getElementById('editForm').style.display = "block";
                document.getElementById('uFname').value = user.fname || "";
                document.getElementById('uMname').value = user.mname || "";
                document.getElementById('uLname').value = user.lname || "";
                document.getElementById('uMobile').value = user.mobile || "";
                document.getElementById('uGender').value = user.gender || "Male";
                document.getElementById('uDob').value = user.dob ? user.dob.split('T')[0] : "";
                document.getElementById('uEmail').value = user.email || "";
                document.getElementById('uFinance').value = user.financeAmount || "";
                document.getElementById('uPass').value = user.password || "";
            } else { alert("User Not Found!"); }
        }

        document.getElementById('editForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('searchUpdateID').value;
            
            // Photo handling
            let photoUrl = null;
            const file = document.getElementById('uPhotoFile').files[0];
            if(file) photoUrl = await convertImage(file);

            const data = {
                fname: document.getElementById('uFname').value,
                mname: document.getElementById('uMname').value,
                lname: document.getElementById('uLname').value,
                mobile: document.getElementById('uMobile').value,
                gender: document.getElementById('uGender').value,
                dob: document.getElementById('uDob').value,
                email: document.getElementById('uEmail').value,
                financeAmount: document.getElementById('uFinance').value,
                password: document.getElementById('uPass').value
            };
            
            if(photoUrl) data.profilePhoto = photoUrl;

            const res = await fetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) { alert("Updated to Cloud DB Successfully!"); closeModal('updateModal'); loadData(); }
        };

        async function sendMsg(type, target) {
            const msg = document.getElementById('msgBody').value;
            const tID = document.getElementById('targetID').value;
            if(type === 'notification' && !tID) return alert("Please enter Target ID!");
            await fetch('/api/admin/send-comms', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: msg, type: type, target: tID || target })
            });
            alert("Message Sent!"); loadHistory();
        }

        async function loadHistory() {
            const res = await fetch('/api/admin/comms-history');
            const history = await res.json();
            const hBody = document.getElementById('historyBody');
            hBody.innerHTML = "";
            history.forEach(h => {
                hBody.innerHTML += `<tr>
                    <td><span class="badge">${h.type}</span></td>
                    <td>${h.target}</td>
                    <td>${h.message}</td>
                    <td><button onclick="deleteHistory('${h._id}')" style="color:red; background:none; border:none; cursor:pointer;"><i class="fa fa-trash"></i></button></td>
                </tr>`;
            });
        }

        async function deleteHistory(id) {
            if(confirm("Delete this message?")) {
                await fetch(`/api/admin/comms/${id}`, { method: 'DELETE' });
                loadHistory();
            }
        }

        function generateCredentials() {
            document.getElementById('regID').value = "BBCC" + Math.floor(1000+Math.random()*9000);
            document.getElementById('regPass').value = Math.random().toString(36).slice(-6).toUpperCase();
        }
        function exportToExcel(id) { 
            const table = document.getElementById(id);
            XLSX.writeFile(XLSX.utils.table_to_book(table), `Report_${new Date().toLocaleDateString()}.xlsx`); 
        }
        function logout() { localStorage.clear(); window.location.href="/"; }

        window.onload = loadData;
    </script>
</body>
</html>
