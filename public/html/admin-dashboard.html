<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Admin Panel | BBCC</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .division-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; color: white; }
        .div-first { background: #10b981; }
        .div-second { background: #3b82f6; }
        .div-third { background: #f59e0b; }
        .div-fail { background: #ef4444; }
        .obtained-marks { width: 60px; padding: 5px; border-radius: 4px; border: 1px solid #444; background: #000; color: #fff; }
        .class-badge { background: #555; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-left"><img src="/assets/logo.png" alt="Logo" class="logo"></div>
        <div class="nav-center"><h1 class="glow-text">BBCC Portal Control</h1></div>
        <div class="nav-right">
            <span id="adminDisplayName">Admin</span>
            <button class="logout-mini" onclick="logout()"><i class="fa fa-sign-out-alt"></i></button>
        </div>
    </nav>

    <div class="main-menu">
        <button class="menu-btn" onclick="openModal('regModal')"><i class="fa fa-user-plus"></i> <span>Registration</span></button>
        <button class="menu-btn" onclick="openModal('updateModal')"><i class="fa fa-user-edit"></i> <span>Update User</span></button>
        <button class="menu-btn" onclick="openModal('commModal')"><i class="fa fa-bullhorn"></i> <span>Communications</span></button>
        <button class="menu-btn" onclick="openModal('teacherModal')"><i class="fa fa-chalkboard-teacher"></i> <span>Teacher Mgmt</span></button>
        <button class="menu-btn" onclick="openModal('studentModal')"><i class="fa fa-user-graduate"></i> <span>Student Mgmt</span></button>
        <button class="menu-btn" onclick="openModal('resultModal')"><i class="fa fa-file-invoice"></i> <span>Update Result</span></button>
    </div>

<div id="resultModal" class="modal wide-modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('resultModal')">&times;</span>
        <h2><i class="fa fa-file-invoice"></i> Update Student Results</h2>
        <div class="batch-config">
            <div>
                <label>Select Class: </label>
                <select id="resClassSelect">
                    <option value="">-- Loading Classes --</option>
                </select>
            </div>
            <div>
                <label>Total Marks (All Students): </label>
                <input type="number" id="globalTotalMarks" value="500" oninput="updateAllDivisions()">
            </div>
            <button onclick="loadStudentsForResult()" class="btn-s">Go / Load Students</button>
        </div>
        <div class="table-scroll">
            <table class="result-table">
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>Roll No (ID)</th>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Marks Obtained</th>
                        <th>Total Marks</th>
                        <th>Division</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody"></tbody>
            </table>
        </div>
        <button onclick="saveAllResults()" class="save-btn" style="margin-top:20px;">Save All Results to Cloud</button>
    </div>
</div>

    <div id="regModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('regModal')">&times;</span>
            <h2><i class="fa fa-id-card"></i> User Registration</h2>
            <form id="regForm">
                <div class="modal-grid">
                    <input type="text" id="fname" placeholder="First Name" required>
                    <input type="text" id="mname" placeholder="Middle Name">
                    <input type="text" id="lname" placeholder="Last Name" required>
                    <input type="text" id="regMobile" placeholder="Mobile Number" required>
                    <select id="gender"><option value="Male">Male</option><option value="Female">Female</option></select>
                    <select id="regRole">
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                    </select>
                    <select id="regClass">
                        <option value="">Select Class (For Students)</option>
                        <option value="5th">5th Standard</option>
                        <option value="6th">6th Standard</option>
                        <option value="7th">7th Standard</option>
                        <option value="8th">8th Standard</option>
                        <option value="9th">9th Standard</option>
                        <option value="10th">10th Standard</option>
                        <option value="11th">11th Standard</option>
                        <option value="12th">12th Standard</option>
                    </select>
                    <input type="date" id="dob">
                    <input type="email" id="email" placeholder="Email ID">
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <label style="font-size:12px;">Upload Photo (.png/.jpg)</label>
                        <input type="file" id="photoFile" accept="image/*">
                    </div>
                    <input type="number" id="financeAmount" placeholder="Fees/Salary">
                    <div class="id-pass-group">
                        <input type="text" id="regID" placeholder="User ID/Roll No">
                        <input type="text" id="regPass" placeholder="Password">
                        <button type="button" onclick="generateCredentials()">Gen</button>
                    </div>
                </div>
                <button type="submit" class="save-btn">Save to Cloud DB</button>
            </form>
        </div>
    </div>

    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('updateModal')">&times;</span>
            <h2><i class="fa fa-edit"></i> Update User Details</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="text" id="searchUpdateID" placeholder="Enter ID to Search">
                <button onclick="fetchUserToEdit()" class="btn-s">Search User</button>
            </div>
            <form id="editForm" style="display:none;">
                <div class="modal-grid">
                    <input type="text" id="uFname" placeholder="First Name">
                    <input type="text" id="uMname" placeholder="Middle Name">
                    <input type="text" id="uLname" placeholder="Last Name">
                    <input type="text" id="uMobile" placeholder="Mobile Number">
                    <select id="uGender"><option value="Male">Male</option><option value="Female">Female</option></select>
                    <select id="uClass">
                        <option value="">Update Class (Optional)</option>
                        <option value="5th">5th Standard</option>
                        <option value="6th">6th Standard</option>
                        <option value="7th">7th Standard</option>
                        <option value="8th">8th Standard</option>
                        <option value="9th">9th Standard</option>
                        <option value="10th">10th Standard</option>
                        <option value="11th">11th Standard</option>
                        <option value="12th">12th Standard</option>
                    </select>
                    <input type="date" id="uDob">
                    <input type="email" id="uEmail" placeholder="Email ID">
                    <input type="number" id="uFinance" placeholder="Fees/Salary">
                    <input type="text" id="uPass" placeholder="Change Password">
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <label style="font-size:12px;">Update Photo (Optional)</label>
                        <input type="file" id="uPhotoFile" accept="image/*">
                    </div>
                </div>
                <button type="submit" class="save-btn">Update to Cloud DB</button>
            </form>
        </div>
    </div>

    <div id="commModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('commModal')">&times;</span>
            <h2><i class="fa fa-broadcast-tower"></i> Send Messages</h2>
            <textarea id="msgBody" placeholder="Write notice here..."></textarea>
            <input type="text" id="targetID" placeholder="Specific ID (Required for Private)">
            <div class="btn-group">
                <button onclick="sendMsg('notice', 'teacher')" class="btn-t">To Teachers</button>
                <button onclick="sendMsg('notice', 'student')" class="btn-s">To Students</button>
                <button onclick="sendMsg('notification', 'private')" class="btn-p">Private (By ID)</button>
            </div>
        </div>
    </div>

    <div id="teacherModal" class="modal wide-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('teacherModal')">&times;</span>
            <div class="modal-header">
                <h2>Teacher Records</h2>
                <button onclick="exportToExcel('teacherTable')" class="excel-btn">Download Excel</button>
            </div>
            <div class="table-scroll">
                <table id="teacherTable">
                    <thead>
                        <tr><th>Photo</th><th>Date</th><th>Name</th><th>Class Assigned</th><th>ID</th><th>Salary</th><th>Contact</th></tr>
                    </thead>
                    <tbody id="tBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="studentModal" class="modal wide-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('studentModal')">&times;</span>
            <div class="modal-header">
                <h2>Student Records</h2>
                <button onclick="exportToExcel('studentTable')" class="excel-btn">Download Excel</button>
            </div>
            <div class="table-scroll">
                <table id="studentTable">
                    <thead>
                        <tr><th>Photo</th><th>Date</th><th>Name</th><th>Class</th><th>ID</th><th>Fees</th><th>Contact</th></tr>
                    </thead>
                    <tbody id="sBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="dashboard-history" style="padding: 20px 5%;">
        <div class="card" style="background: var(--card-bg); padding: 20px; border-radius: 15px;">
            <h3><i class="fa fa-history"></i> Recent Messages History</h3>
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr><th>Type</th><th>Target ID</th><th>Message</th><th>Action</th></tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- SESSION SECURITY CHECK ---
        (function() {
            const userData = JSON.parse(localStorage.getItem('userData'));
            
            // Agar data nahi hai ya role 'admin' nahi hai, toh turant bahar phenk do
            if (!userData || userData.role !== 'admin') {
                alert("⛔ Access Denied! Please login as Admin.");
                window.location.href = "/"; // Login page par redirect
            }
        })();
        // ------------------------------

        const socket = io();
        let mainData = [];

        window.onload = loadData;

        async function loadData() {
            const res = await fetch('/api/admin/users');
            mainData = await res.json();
            renderTables(mainData);
            loadHistory();
            refreshClassList();
        }

        function openModal(id) { 
            document.getElementById(id).style.display = "block"; 
            if(id === 'resultModal') refreshClassList();
        }

        function closeModal(id) { document.getElementById(id).style.display = "none"; }

        function refreshClassList() {
            const classSelect = document.getElementById('resClassSelect');
            if(!classSelect) return;
            
            const classes = [...new Set(mainData
                .filter(u => u.role === 'student' && (u.studentClass || u.class)) 
                .map(u => u.studentClass || u.class))];

            if(classes.length > 0) {
                classSelect.innerHTML = '<option value="">-- Select Class --</option>' + 
                    classes.map(c => `<option value="${c}">${c}</option>`).join('');
            } else {
                classSelect.innerHTML = '<option value="">No Students Found</option>';
            }
        }

        function renderTables(data) {
            const tBody = document.getElementById('tBody');
            const sBody = document.getElementById('sBody');
            tBody.innerHTML = ""; sBody.innerHTML = "";
            data.forEach(u => {
                const userClass = u.studentClass || u.class || "N/A";
                const row = `<tr>
                    <td><img src="${u.profilePhoto || '/assets/default-user.png'}" class="table-img"></td>
                    <td>${new Date(u.joinDate).toLocaleDateString()}</td>
                    <td>${u.fname} ${u.lname}</td>
                    <td><span class="class-badge">${userClass}</span></td>
                    <td><b>${u.username}</b></td>
                    <td>₹${u.financeAmount}</td>
                    <td class="action-icons">
                        <a href="tel:${u.mobile}"><i class="fa fa-phone"></i></a>
                        <a href="https://wa.me/91${u.mobile}" style="color:#25D366;"><i class="fab fa-whatsapp"></i></a>
                    </td>
                </tr>`;
                if(u.role === 'teacher') tBody.innerHTML += row;
                else sBody.innerHTML += row;
            });
        }

        async function fetchUserToEdit() {
            const id = document.getElementById('searchUpdateID').value;
            const user = mainData.find(u => u.username === id);
            if(user) {
                document.getElementById('editForm').style.display = "block";
                document.getElementById('uFname').value = user.fname || "";
                document.getElementById('uMname').value = user.mname || "";
                document.getElementById('uLname').value = user.lname || "";
                document.getElementById('uMobile').value = user.mobile || "";
                document.getElementById('uGender').value = user.gender || "Male";
                document.getElementById('uClass').value = user.studentClass || user.class || "";
                document.getElementById('uDob').value = user.dob ? user.dob.split('T')[0] : "";
                document.getElementById('uEmail').value = user.email || "";
                document.getElementById('uFinance').value = user.financeAmount || "";
                document.getElementById('uPass').value = user.password || "";
            } else { alert("User Not Found!"); }
        }

        document.getElementById('editForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('searchUpdateID').value;
            let photoUrl = null;
            const file = document.getElementById('uPhotoFile').files[0];
            if(file) photoUrl = await convertImage(file);
            const data = {
                fname: document.getElementById('uFname').value,
                mname: document.getElementById('uMname').value,
                lname: document.getElementById('uLname').value,
                mobile: document.getElementById('uMobile').value,
                gender: document.getElementById('uGender').value,
                studentClass: document.getElementById('uClass').value,
                dob: document.getElementById('uDob').value,
                email: document.getElementById('uEmail').value,
                financeAmount: document.getElementById('uFinance').value,
                password: document.getElementById('uPass').value
            };
            if(photoUrl) data.profilePhoto = photoUrl;
            const res = await fetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) { alert("Updated Successfully!"); closeModal('updateModal'); loadData(); }
        };

        function loadStudentsForResult() {
            const selectedClass = document.getElementById('resClassSelect').value;
            const globalTotal = document.getElementById('globalTotalMarks').value;
            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = "";
            if(!selectedClass) return alert("Pahle class select karein!");
            const students = mainData.filter(u => u.role === 'student' && (u.studentClass === selectedClass || u.class === selectedClass));
            if(students.length === 0) {
                tbody.innerHTML = "<tr><td colspan='7'>No students in this class.</td></tr>";
                return;
            }
            students.forEach(u => {
                tbody.innerHTML += `
                    <tr data-id="${u.username}">
                        <td><img src="${u.profilePhoto || '/assets/default-user.png'}" class="table-img"></td>
                        <td><b>${u.username}</b></td>
                        <td>${u.fname} ${u.lname}</td>
                        <td>${u.mobile}</td>
                        <td><input type="number" class="obtained-marks" value="${u.marksObtained || 0}" oninput="calculateSingleDivision(this)"></td>
                        <td class="total-marks-cell">${globalTotal}</td>
                        <td class="division-cell">-</td>
                    </tr>`;
            });
            updateAllDivisions();
        }

        function calculateSingleDivision(input) {
            const row = input.closest('tr');
            const obtained = parseFloat(input.value) || 0;
            const total = parseFloat(document.getElementById('globalTotalMarks').value) || 1;
            const cell = row.querySelector('.division-cell');
            const percentage = (obtained / total) * 100;
            if (percentage >= 60) cell.innerHTML = '<span class="division-badge div-first">1st Div</span>';
            else if (percentage >= 45) cell.innerHTML = '<span class="division-badge div-second">2nd Div</span>';
            else if (percentage >= 33) cell.innerHTML = '<span class="division-badge div-third">3rd Div</span>';
            else cell.innerHTML = '<span class="division-badge div-fail">Fail</span>';
        }

        function updateAllDivisions() {
            const total = document.getElementById('globalTotalMarks').value;
            document.querySelectorAll('.total-marks-cell').forEach(td => td.innerText = total);
            document.querySelectorAll('.obtained-marks').forEach(input => calculateSingleDivision(input));
        }

        async function saveAllResults() {
            const rows = document.querySelectorAll('#resultTableBody tr');
            if (rows.length === 0) return alert("Load students first!");
            const results = [];
            const globalTotal = document.getElementById('globalTotalMarks').value;
            rows.forEach(row => {
                const obtained = row.querySelector('.obtained-marks').value;
                const percentage = (parseFloat(obtained) / parseFloat(globalTotal)) * 100;
                let division = percentage >= 60 ? "1st Div" : percentage >= 45 ? "2nd Div" : percentage >= 33 ? "3rd Div" : "Fail";
                results.push({ username: row.getAttribute('data-id'), marksObtained: obtained, totalMarks: globalTotal, division: division });
            });
            const res = await fetch('/api/admin/update-batch-results', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ results })
            });
            if(res.ok) { alert("Results Saved!"); loadData(); }
        }

        document.getElementById('regForm').onsubmit = async (e) => {
            e.preventDefault();
            let photoUrl = "/assets/default-user.png";
            const file = document.getElementById('photoFile').files[0];
            if(file) photoUrl = await convertImage(file);
            const data = {
                username: document.getElementById('regID').value,
                password: document.getElementById('regPass').value,
                fname: document.getElementById('fname').value,
                mname: document.getElementById('mname').value,
                lname: document.getElementById('lname').value,
                mobile: document.getElementById('regMobile').value,
                gender: document.getElementById('gender').value,
                dob: document.getElementById('dob').value,
                email: document.getElementById('email').value,
                role: document.getElementById('regRole').value,
                studentClass: document.getElementById('regClass').value,
                financeAmount: document.getElementById('financeAmount').value,
                profilePhoto: photoUrl
            };
            const res = await fetch('/api/admin/create-user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) { alert("Registered!"); closeModal('regModal'); loadData(); }
        };

        function convertImage(file) { return new Promise(resolve => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); }); }
        function generateCredentials() { document.getElementById('regID').value = "BBCC" + Math.floor(1000+Math.random()*9000); document.getElementById('regPass').value = Math.random().toString(36).slice(-6).toUpperCase(); }
        function exportToExcel(id) { const table = document.getElementById(id); XLSX.writeFile(XLSX.utils.table_to_book(table), `Report.xlsx`); }
        async function sendMsg(type, target) {
            const msg = document.getElementById('msgBody').value;
            const tID = document.getElementById('targetID').value;
            await fetch('/api/admin/send-comms', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ message: msg, type: type, target: tID || target }) });
            alert("Sent!"); loadHistory();
        }
        async function loadHistory() {
            const res = await fetch('/api/admin/comms-history');
            const history = await res.json();
            const hBody = document.getElementById('historyBody');
            hBody.innerHTML = history.map(h => `<tr><td>${h.type}</td><td>${h.target}</td><td>${h.message}</td><td><button onclick="deleteHistory('${h._id}')" style="color:red;border:none;background:none;"><i class="fa fa-trash"></i></button></td></tr>`).join('');
        }
        async function deleteHistory(id) { if(confirm("Delete?")) { await fetch(`/api/admin/comms/${id}`, { method: 'DELETE' }); loadHistory(); } }
        function logout() { localStorage.clear(); window.location.href="/"; }
    </script>
</body>
</html>
