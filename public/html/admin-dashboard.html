<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Admin Panel | BBCC</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-left"><img src="/assets/logo.png" alt="Logo" class="logo"></div>
        <div class="nav-center"><h1 class="glow-text">BBCC Portal Control</h1></div>
        <div class="nav-right">
            <span id="adminDisplayName">Admin</span>
            <button class="logout-mini" onclick="logout()"><i class="fa fa-sign-out-alt"></i></button>
        </div>
    </nav>

    <div class="main-menu">
        <button class="menu-btn" onclick="openModal('regModal')">
            <i class="fa fa-user-plus"></i> <span>New Registration</span>
        </button>
        <button class="menu-btn" onclick="openModal('commModal')">
            <i class="fa fa-bullhorn"></i> <span>Communications</span>
        </button>
        <button class="menu-btn" onclick="openModal('teacherModal')">
            <i class="fa fa-chalkboard-teacher"></i> <span>Teacher Mgmt</span>
        </button>
        <button class="menu-btn" onclick="openModal('studentModal')">
            <i class="fa fa-user-graduate"></i> <span>Student Mgmt</span>
        </button>
    </div>

    <div id="regModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('regModal')">&times;</span>
            <h2><i class="fa fa-id-card"></i> User Registration</h2>
            <form id="regForm">
                <div class="modal-grid">
                    <input type="text" id="fname" placeholder="First Name" required>
                    <input type="text" id="mname" placeholder="Middle Name">
                    <input type="text" id="lname" placeholder="Last Name" required>
                    <input type="text" id="regMobile" placeholder="Mobile Number" required>
                    <select id="gender"><option value="Male">Male</option><option value="Female">Female</option></select>
                    <select id="regRole" onchange="toggleFinance()">
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                    </select>
                    <input type="date" id="dob" title="Date of Birth">
                    <input type="email" id="email" placeholder="Email ID">
                    <input type="text" id="photo" placeholder="Photo URL (Link)">
                    <input type="number" id="financeAmount" placeholder="Fees/Salary">
                    <div class="id-pass-group">
                        <input type="text" id="regID" placeholder="User ID/Roll No">
                        <input type="text" id="regPass" placeholder="Password">
                        <button type="button" onclick="generateCredentials()">Gen</button>
                    </div>
                </div>
                <button type="submit" class="save-btn">Save to Cloud DB</button>
            </form>
        </div>
    </div>

    <div id="commModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('commModal')">&times;</span>
            <h2><i class="fa fa-broadcast-tower"></i> Send Messages</h2>
            <textarea id="msgBody" placeholder="Write notice or private message here..."></textarea>
            <div class="target-row">
                <input type="text" id="targetID" placeholder="Specific ID (Optional for Private)">
            </div>
            <div class="btn-group">
                <button onclick="sendMsg('notice', 'teacher')" class="btn-t">To Teachers</button>
                <button onclick="sendMsg('notice', 'student')" class="btn-s">To Students</button>
                <button onclick="sendMsg('notification', 'private')" class="btn-p">Private (By ID)</button>
            </div>
        </div>
    </div>

    <div id="teacherModal" class="modal wide-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('teacherModal')">&times;</span>
            <div class="modal-header">
                <h2>Teacher Records</h2>
                <button onclick="exportToExcel('teacherTable')" class="excel-btn">Excel</button>
            </div>
            <div class="table-scroll">
                <table id="teacherTable">
                    <thead>
                        <tr><th>Photo</th><th>Date</th><th>Name</th><th>ID</th><th>Pass</th><th>Salary</th><th>Contact</th></tr>
                    </thead>
                    <tbody id="tBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="studentModal" class="modal wide-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('studentModal')">&times;</span>
            <div class="modal-header">
                <h2>Student Records</h2>
                <button onclick="exportToExcel('studentTable')" class="excel-btn">Excel</button>
            </div>
            <div class="table-scroll">
                <table id="studentTable">
                    <thead>
                        <tr><th>Photo</th><th>Date</th><th>Name</th><th>ID</th><th>Pass</th><th>Fees</th><th>Contact</th></tr>
                    </thead>
                    <tbody id="sBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // Modal Functions
        function openModal(id) { document.getElementById(id).style.display = "block"; loadData(); }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }

        // Data Loading
        async function loadData() {
            const res = await fetch('/api/admin/users');
            const users = await res.json();
            const tBody = document.getElementById('tBody');
            const sBody = document.getElementById('sBody');
            tBody.innerHTML = ""; sBody.innerHTML = "";

            users.forEach(u => {
                const row = `<tr>
                    <td><img src="${u.profilePhoto}" class="table-img"></td>
                    <td>${new Date(u.joinDate).toLocaleDateString()}</td>
                    <td>${u.fname} ${u.lname}</td>
                    <td><b>${u.username}</b></td>
                    <td>${u.password}</td>
                    <td>â‚¹${u.financeAmount}</td>
                    <td><a href="tel:${u.mobile}"><i class="fa fa-phone"></i></a></td>
                </tr>`;
                if(u.role === 'teacher') tBody.innerHTML += row;
                else sBody.innerHTML += row;
            });
        }

        // Registration
        document.getElementById('regForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                username: document.getElementById('regID').value,
                password: document.getElementById('regPass').value,
                fname: document.getElementById('fname').value,
                lname: document.getElementById('lname').value,
                mobile: document.getElementById('regMobile').value,
                role: document.getElementById('regRole').value,
                financeAmount: document.getElementById('financeAmount').value,
                profilePhoto: document.getElementById('photo').value || "/assets/default-user.png"
            };
            const res = await fetch('/api/admin/create-user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) { alert("Registered!"); closeModal('regModal'); }
        };

        function generateCredentials() {
            document.getElementById('regID').value = "BBCC" + Math.floor(1000+Math.random()*9000);
            document.getElementById('regPass').value = Math.random().toString(36).slice(-6).toUpperCase();
        }

        async function sendMsg(type, target) {
            const msg = document.getElementById('msgBody').value;
            const tID = document.getElementById('targetID').value;
            const res = await fetch('/api/admin/send-comms', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: msg, type: type, target: tID || target })
            });
            if(res.ok) alert("Sent!");
        }

        function exportToExcel(id) { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById(id)), `Report.xlsx`); }
        function logout() { localStorage.clear(); window.location.href="/"; }
    </script>
</body>
</html>
