<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Admin Panel | BBCC</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-left">
            <div class="logo-container">
                <img src="/assets/logo.png" alt="Logo" class="logo">
            </div>
        </div>
        <div class="nav-center"><h1 class="glow-text">BBCC Portal Control</h1></div>
        <div class="nav-right">
            <span id="adminDisplayName">Admin</span>
            <button class="logout-mini" onclick="logout()"><i class="fa fa-sign-out-alt"></i></button>
        </div>
    </nav>

    <div class="main-menu">
        <button class="menu-btn" onclick="openModal('regModal')"><i class="fa fa-user-plus"></i> <span>Registration</span></button>
        <button class="menu-btn" onclick="openModal('updateModal')"><i class="fa fa-user-edit"></i> <span>Update User</span></button>
        <button class="menu-btn" onclick="openModal('commModal')"><i class="fa fa-bullhorn"></i> <span>Send Messages</span></button>
        <button class="menu-btn" onclick="openModal('teacherModal')"><i class="fa fa-chalkboard-teacher"></i> <span>Teacher Mgmt</span></button>
        <button class="menu-btn" onclick="openModal('studentModal')"><i class="fa fa-user-graduate"></i> <span>Student Mgmt</span></button>
    </div>

    <div class="dashboard-history card">
        <h3><i class="fa fa-history"></i> Recent Communications History</h3>
        <div class="table-scroll">
            <table>
                <thead>
                    <tr><th>Type</th><th>Target</th><th>Message</th><th>Actions</th></tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>

    <div id="regModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('regModal')">&times;</span>
            <h2>Registration</h2>
            <form id="regForm">
                <div class="modal-grid">
                    <input type="text" id="fname" placeholder="First Name" required>
                    <input type="text" id="lname" placeholder="Last Name" required>
                    <input type="text" id="regMobile" placeholder="Mobile Number" required>
                    <select id="regRole"><option value="student">Student</option><option value="teacher">Teacher</option></select>
                    <input type="file" id="photoFile" accept="image/*">
                    <input type="number" id="financeAmount" placeholder="Fees/Salary">
                    <div class="id-pass-group">
                        <input type="text" id="regID" placeholder="User ID">
                        <input type="text" id="regPass" placeholder="Password">
                        <button type="button" onclick="generateCredentials()">Gen</button>
                    </div>
                </div>
                <button type="submit" class="save-btn">Save to Cloud DB</button>
            </form>
        </div>
    </div>

    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('updateModal')">&times;</span>
            <h2>Update User Details</h2>
            <div class="search-group" style="margin-bottom:20px;">
                <input type="text" id="updateSearchID" placeholder="Enter User ID to Edit">
                <button onclick="fetchUserForUpdate()" class="gen-btn">Find</button>
            </div>
            <form id="updateForm" style="display:none;">
                <div class="modal-grid">
                    <input type="text" id="uFname" placeholder="First Name">
                    <input type="text" id="uLname" placeholder="Last Name">
                    <input type="text" id="uMobile" placeholder="Mobile">
                    <input type="number" id="uFinance" placeholder="Fees/Salary">
                </div>
                <button type="submit" class="save-btn">Update Profile</button>
            </form>
        </div>
    </div>

    <div id="commModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('commModal')">&times;</span>
            <h2>Broadcast</h2>
            <textarea id="msgBody" placeholder="Type message..."></textarea>
            <input type="text" id="targetID" placeholder="Target ID (Required for Private)">
            <div class="btn-group">
                <button onclick="sendMsg('notice', 'teacher')" class="btn-t">Teacher</button>
                <button onclick="sendMsg('notice', 'student')" class="btn-s">Student</button>
                <button onclick="sendMsg('notification', 'private')" class="btn-p">Private ID</button>
            </div>
        </div>
    </div>

    <div id="teacherModal" class="modal wide-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('teacherModal')">&times;</span>
            <div class="modal-header">
                <div class="search-bar">
                    <input type="text" id="tSearchID" placeholder="Search ID">
                    <input type="date" id="tSD"> to <input type="date" id="tED">
                    <button onclick="filterRecords('teacher')">Search</button>
                </div>
                <button onclick="exportToExcel('teacherTable')" class="excel-btn">Download PDF/Excel</button>
            </div>
            <div class="table-scroll"><table id="teacherTable"><thead><tr><th>Photo</th><th>Date</th><th>Name</th><th>ID</th><th>Salary</th><th>Contact</th></tr></thead><tbody id="tBody"></tbody></table></div>
        </div>
    </div>

    <div id="studentModal" class="modal wide-modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('studentModal')">&times;</span>
            <div class="modal-header">
                <div class="search-bar">
                    <input type="text" id="sSearchID" placeholder="Search ID">
                    <input type="date" id="sSD"> to <input type="date" id="sED">
                    <button onclick="filterRecords('student')">Search</button>
                </div>
                <button onclick="exportToExcel('studentTable')" class="excel-btn">Download List</button>
            </div>
            <div class="table-scroll"><table id="studentTable"><thead><tr><th>Photo</th><th>Date</th><th>Name</th><th>ID</th><th>Fees</th><th>Contact</th></tr></thead><tbody id="sBody"></tbody></table></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let allUsers = [];

        async function loadData() {
            const res = await fetch('/api/admin/users');
            allUsers = await res.json();
            renderTable(allUsers, 'teacher', 'tBody');
            renderTable(allUsers, 'student', 'sBody');
            loadHistory();
        }

        function renderTable(data, role, bodyId) {
            const body = document.getElementById(bodyId);
            body.innerHTML = "";
            data.filter(u => u.role === role).forEach(u => {
                body.innerHTML += `<tr>
                    <td><img src="${u.profilePhoto}" class="table-img"></td>
                    <td>${new Date(u.joinDate).toLocaleDateString()}</td>
                    <td>${u.fname} ${u.lname}</td>
                    <td>${u.username}</td>
                    <td>â‚¹${u.financeAmount}</td>
                    <td class="action-icons">
                        <a href="tel:${u.mobile}"><i class="fa fa-phone"></i></a>
                        <a href="https://wa.me/91${u.mobile}"><i class="fab fa-whatsapp"></i></a>
                        <a href="sms:${u.mobile}"><i class="fa fa-comment-alt"></i></a>
                    </td>
                </tr>`;
            });
        }

        // Search Filter Logic
        function filterRecords(role) {
            const id = document.getElementById(role === 'teacher' ? 'tSearchID' : 'sSearchID').value.toLowerCase();
            const sd = document.getElementById(role === 'teacher' ? 'tSD' : 'sSD').value;
            const ed = document.getElementById(role === 'teacher' ? 'tED' : 'sED').value;

            const filtered = allUsers.filter(u => {
                const matchID = u.username.toLowerCase().includes(id);
                const uDate = new Date(u.joinDate).toISOString().split('T')[0];
                const matchDate = (sd && ed) ? (uDate >= sd && uDate <= ed) : true;
                return u.role === role && matchID && matchDate;
            });
            renderTable(filtered, role, role === 'teacher' ? 'tBody' : 'sBody');
        }

        // Photo to Base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        document.getElementById('regForm').onsubmit = async (e) => {
            e.preventDefault();
            let photo = "/assets/default.png";
            const file = document.getElementById('photoFile').files[0];
            if(file) photo = await getBase64(file);

            const data = {
                fname: document.getElementById('fname').value,
                lname: document.getElementById('lname').value,
                username: document.getElementById('regID').value,
                password: document.getElementById('regPass').value,
                mobile: document.getElementById('regMobile').value,
                role: document.getElementById('regRole').value,
                financeAmount: document.getElementById('financeAmount').value,
                profilePhoto: photo
            };
            
            const res = await fetch('/api/admin/create-user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if(res.ok) { alert("User Saved!"); closeModal('regModal'); loadData(); }
        };

        // Communication with History
        async function loadHistory() {
            const res = await fetch('/api/admin/comms-history');
            const history = await res.json();
            const hBody = document.getElementById('historyBody');
            hBody.innerHTML = "";
            history.forEach(h => {
                hBody.innerHTML += `<tr>
                    <td>${h.type}</td>
                    <td>${h.target}</td>
                    <td>${h.message}</td>
                    <td>
                        <button onclick="deleteComm('${h._id}')" class="logout-mini"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        async function sendMsg(type, target) {
            const msg = document.getElementById('msgBody').value;
            const tID = document.getElementById('targetID').value;
            if(target === 'private' && !tID) return alert("ID is required for Private Message!");

            await fetch('/api/admin/send-comms', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: msg, type: type, target: tID || target })
            });
            alert("Sent!"); loadHistory();
        }

        // Helpers
        function openModal(id) { document.getElementById(id).style.display = "block"; loadData(); }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        function generateCredentials() {
            document.getElementById('regID').value = "BBCC" + Math.floor(1000+Math.random()*9000);
            document.getElementById('regPass').value = Math.random().toString(36).slice(-6).toUpperCase();
        }
        function exportToExcel(tableId) {
            const table = document.getElementById(tableId);
            XLSX.writeFile(XLSX.utils.table_to_book(table), `Filtered_Report.xlsx`);
        }
        function logout() { localStorage.clear(); window.location.href="/"; }

        window.onload = loadData;
    </script>
</body>
</html>
