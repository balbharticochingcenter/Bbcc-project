<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Admin Panel | BBCC</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

    <nav class="navbar">
        <div class="nav-left"><img src="/assets/logo.png" alt="Logo" class="logo"></div>
        <div class="nav-center"><h1 class="glow-text">Balbharti Coaching Center</h1></div>
        <div class="nav-right">
            <div class="profile-dropdown">
                <div class="profile-trigger">
                    <img src="/assets/admin-avatar.png" id="navAvatar" alt="Admin">
                    <span id="adminDisplayName">Admin Profile</span>
                </div>
                <div class="dropdown-menu">
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="dashboard-content">
        <div class="admin-grid">
            <section class="card registration-card">
                <h2><i class="fa fa-user-plus"></i> User Registration</h2>
                <form id="regForm">
                    <div class="form-grid">
                        <input type="text" id="fname" placeholder="First Name" required>
                        <input type="text" id="mname" placeholder="Middle Name">
                        <input type="text" id="lname" placeholder="Last Name" required>
                        <input type="text" id="regMobile" placeholder="Mobile Number" required>
                        <select id="regRole" onchange="toggleFinancePlaceholder()">
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                        </select>
                        <input type="number" id="financeAmount" placeholder="Monthly Fees">
                        <input type="date" id="joinDate" required>
                        <div class="id-pass-container">
                            <input type="text" id="regID" placeholder="Manual ID" required>
                            <input type="text" id="regPass" placeholder="Password" required>
                            <button type="button" onclick="generateCredentials()" class="gen-btn">Gen</button>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn">Register & Save to DB</button>
                </form>
            </section>

            <section class="card communication-card">
                <h2><i class="fa fa-bullhorn"></i> Communications Center</h2>
                
                <div class="comm-split">
                    <div class="comm-box">
                        <h3>Official Notices (Public)</h3>
                        <textarea id="noticeMsg" placeholder="Type official notice here..."></textarea>
                        <div class="comms-actions">
                            <button onclick="sendComms('notice', 'teacher')" class="btn-t">Teacher</button>
                            <button onclick="sendComms('notice', 'student')" class="btn-s">Student</button>
                            <button onclick="sendComms('notice', 'all')" class="btn-a">All</button>
                        </div>
                    </div>
                    <div class="comm-box">
                        <h3>App Notifications (Alerts)</h3>
                        <textarea id="notifMsg" placeholder="Type app notification here..."></textarea>
                        <div class="comms-actions">
                            <button onclick="sendComms('notification', 'teacher')" class="btn-t">Teacher</button>
                            <button onclick="sendComms('notification', 'student')" class="btn-s">Student</button>
                            <button onclick="sendComms('notification', 'all')" class="btn-a">All</button>
                        </div>
                    </div>
                </div>

                <div class="history-grid">
                    <div class="history-box"><h4>Old Notices</h4><ul id="noticeHistory"></ul></div>
                    <div class="history-box"><h4>Old Notifications</h4><ul id="notifHistory"></ul></div>
                </div>
            </section>
        </div>

        <section class="card table-card">
            <div class="card-header">
                <h2><i class="fa fa-chalkboard-teacher"></i> Teacher Management</h2>
                <div class="search-box">
                    <input type="text" id="searchTeacherID" placeholder="Search ID...">
                    <input type="date" id="searchTeacherDate">
                    <button onclick="filterTable('teacher')" class="search-btn"><i class="fa fa-search"></i></button>
                </div>
                <button onclick="exportToExcel('teacherTable')" class="dl-btn">Excel</button>
            </div>
            <table id="teacherTable">
                <thead>
                    <tr><th>Date</th><th>Name</th><th>ID</th><th>Password</th><th>Salary</th><th>Status</th><th>Contact</th></tr>
                </thead>
                <tbody id="teacherTableBody"></tbody>
            </table>
        </section>

        <section class="card table-card">
            <div class="card-header">
                <h2><i class="fa fa-user-graduate"></i> Student Management</h2>
                <div class="search-box">
                    <input type="text" id="searchStudentID" placeholder="Search ID...">
                    <input type="date" id="searchStudentDate">
                    <button onclick="filterTable('student')" class="search-btn"><i class="fa fa-search"></i></button>
                </div>
                <button onclick="exportToExcel('studentTable')" class="dl-btn">Excel</button>
            </div>
            <table id="studentTable">
                <thead>
                    <tr><th>Date</th><th>Name</th><th>ID</th><th>Password</th><th>Fees</th><th>Status</th><th>Contact</th></tr>
                </thead>
                <tbody id="studentTableBody"></tbody>
            </table>
        </section>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let allUsers = [];

        // Security & Display Name
        const adminData = JSON.parse(localStorage.getItem('userData'));
        if(!adminData || adminData.role !== 'admin') window.location.href = '/';
        else document.getElementById('adminDisplayName').innerText = adminData.fname + " " + adminData.lname;

        // --- 1. Load Data ---
        async function loadData() {
            try {
                // Fetch Users
                const uRes = await fetch('/api/admin/users');
                allUsers = await uRes.json();
                renderTables(allUsers);

                // Fetch Comms History
                const cRes = await fetch('/api/admin/comms-history');
                const history = await cRes.json();
                renderHistory(history);
            } catch (err) { console.error(err); }
        }

        function renderTables(data) {
            const sBody = document.getElementById('studentTableBody');
            const tBody = document.getElementById('teacherTableBody');
            sBody.innerHTML = ""; tBody.innerHTML = "";

            data.forEach(user => {
                const row = `<tr>
                    <td>${user.joinDate}</td>
                    <td>${user.fname} ${user.lname}</td>
                    <td><b>${user.username}</b></td>
                    <td>${user.password}</td>
                    <td>â‚¹${user.financeAmount}</td>
                    <td><span class="status-badge">${user.paymentStatus || 'Unpaid'}</span></td>
                    <td class="action-icons">
                        <a href="tel:${user.mobile}"><i class="fa fa-phone"></i></a>
                        <a href="https://wa.me/91${user.mobile}" target="_blank"><i class="fab fa-whatsapp"></i></a>
                    </td>
                </tr>`;
                if(user.role === 'student') sBody.innerHTML += row;
                else if(user.role === 'teacher') tBody.innerHTML += row;
            });
        }

        function renderHistory(history) {
            const nLog = document.getElementById('noticeHistory');
            const ntLog = document.getElementById('notifHistory');
            nLog.innerHTML = ""; ntLog.innerHTML = "";

            history.forEach(item => {
                const li = `<li>[${item.target.toUpperCase()}] ${item.message}</li>`;
                if(item.type === 'notice') nLog.innerHTML += li;
                else ntLog.innerHTML += li;
            });
        }

        // --- 2. Registration ---
        document.getElementById('regForm').onsubmit = async (e) => {
            e.preventDefault();
            const newUser = {
                fname: document.getElementById('fname').value,
                mname: document.getElementById('mname').value,
                lname: document.getElementById('lname').value,
                username: document.getElementById('regID').value,
                password: document.getElementById('regPass').value,
                role: document.getElementById('regRole').value,
                mobile: document.getElementById('regMobile').value,
                financeAmount: document.getElementById('financeAmount').value,
                joinDate: document.getElementById('joinDate').value
            };
            const res = await fetch('/api/admin/create-user', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(newUser)
            });
            if(res.ok) { alert("User Saved!"); loadData(); }
        };

        // --- 3. Advanced Search/Filter ---
        function filterTable(role) {
            const idKey = role === 'student' ? 'searchStudentID' : 'searchTeacherID';
            const dateKey = role === 'student' ? 'searchStudentDate' : 'searchTeacherDate';
            
            const searchID = document.getElementById(idKey).value.toLowerCase();
            const searchDate = document.getElementById(dateKey).value;

            const filtered = allUsers.filter(u => {
                const matchID = u.username.toLowerCase().includes(searchID);
                const matchDate = searchDate ? u.joinDate === searchDate : true;
                return u.role === role && matchID && matchDate;
            });

            renderTables(filtered);
        }

        // --- 4. Dual Comms (Save & Broadcast) ---
        async function sendComms(type, target) {
            const fieldID = type === 'notice' ? 'noticeMsg' : 'notifMsg';
            const msg = document.getElementById(fieldID).value;
            if(!msg) return alert("Message is empty!");

            const res = await fetch('/api/admin/send-comms', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: msg, target: target, type: type })
            });

            if(res.ok) {
                alert(`${type} Sent Successfully!`);
                document.getElementById(fieldID).value = "";
                loadData();
            }
        }

        // --- Helpers ---
        function generateCredentials() {
            document.getElementById('regID').value = "BBCC" + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('regPass').value = Math.random().toString(36).slice(-6).toUpperCase();
        }
        function toggleFinancePlaceholder() {
            const role = document.getElementById('regRole').value;
            document.getElementById('financeAmount').placeholder = (role === 'student') ? "Monthly Fees" : "Monthly Salary";
        }
        function exportToExcel(tID) {
            XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById(tID)), `${tID}.xlsx`);
        }
        function logout() { localStorage.clear(); window.location.href = '/'; }

        window.onload = loadData;
    </script>
</body>
</html>
