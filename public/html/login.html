<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Balbharti Coaching Center</title>
    <link rel="stylesheet" href="/css/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Extra CSS for dynamic layout */
        .enroll-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            transition: 0.3s;
        }
        .enroll-btn:hover { background: #b91c1c; transform: scale(1.05); }
        .box-back p { font-size: 0.85rem; margin-bottom: 10px; }
        .brand-info { display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap; }
        .powered-by { font-size: 0.9rem; color: var(--primary); opacity: 0.8; }

        /* Result Button Style */
        .result-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
            transition: 0.3s;
        }
        .result-btn:hover { background: #059669; }
        .nav-right { display: flex; align-items: center; }

        /* Result Card UI */
        #resultContainer {
            display: none;
            margin-top: 20px;
            background: white;
            color: #1e293b;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #38bdf8;
            text-align: center;
        }
        .res-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        .res-photo {
            width: 100px; height: 100px;
            border-radius: 50%; border: 3px solid #38bdf8;
            object-fit: cover; margin-bottom: 10px;
        }
        .download-res-btn {
            background: #0f172a; color: white;
            border: none; padding: 10px; margin-top: 15px;
            width: 100%; border-radius: 5px; cursor: pointer;
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-left">
            <div class="logo-ring">
                <img src="/assets/logo.png" alt="Logo" class="logo" id="siteLogo">
            </div>
        </div>
        
        <div class="nav-center">
            <div class="brand-info">
                <h1 class="glow-text rainbow-header" id="siteTitle">Loading...</h1>
                <span class="powered-by" id="siteSubTitle"></span>
            </div>
        </div>

        <div class="nav-right">
            <button class="result-btn" onclick="openResultPopup()">
                <i class="fa-solid fa-graduation-cap"></i> Student Results
            </button>
            <button class="dropbtn" onclick="openPopup()">
                <i class="fa-solid fa-user-shield"></i> Portal Login
            </button>
        </div>

        <div id="resultPopup" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeResultPopup()">&times;</span>
                <h2 style="color: #38bdf8;"><i class="fa fa-search"></i> Check Result</h2>
                <div class="input-group">
                    <input type="text" id="resRoll" placeholder="Enter Roll Number / ID">
                </div>
                <div class="input-group">
                    <input type="text" id="resMobile" placeholder="Enter Mobile Number">
                </div>
                <button class="btn-go" onclick="searchResult()">
                    Search Result <i class="fa fa-search"></i>
                </button>

                <div id="resultContainer">
                    <div id="resultCardCapture" class="res-card">
                        <h3 style="margin-bottom: 5px;">BALBHARTI COACHING CENTER</h3>
                        <p style="font-size: 0.7rem; color: #64748b; margin-bottom: 10px;">EXAM PROGRESS REPORT</p>
                        <img id="stPhoto" src="/assets/default-user.png" class="res-photo">
                        <h4 id="stName">Student Name</h4>
                        <p>ID: <b id="stID">000</b></p>
                        <hr style="margin: 10px 0;">
                        <p>Total Marks: <b id="stMarks">00</b></p>
                        <p>Division: <span id="stDiv" style="color: #10b981; font-weight: bold;">First</span></p>
                    </div>
                    <button class="download-res-btn" onclick="downloadJPG()">
                        <i class="fa fa-download"></i> Download Result JPG
                    </button>
                </div>
            </div>
        </div>

        <div id="loginPopup" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePopup()">&times;</span>
                <i class="fa-solid fa-circle-user" style="font-size: 50px; color: #38bdf8; margin-bottom: 10px;"></i>
                <h2>Student Login</h2>
                <div class="input-group">
                    <input type="text" id="username" placeholder="Enter Your ID">
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Enter Password">
                </div>
                <button class="btn-go" onclick="login()">
                    Unlock Dashboard <i class="fa-solid fa-arrow-right"></i>
                </button>
                <p style="margin-top: 20px; font-size: 0.8rem; color: #94a3b8;">
                    Forget Password? Contact Admin
                </p>
            </div>
        </div>
    </nav>

    <section class="slider-container" id="mainSlider">
        <img src="/slider/img1.jpg" class="slide active" alt="Banner 1">
        <img src="/slider/img2.jpg" class="slide" alt="Banner 2">
        <img src="/slider/img3.jpg" class="slide" alt="Banner 3">
    </section>

    <section class="stats-container">
        <div class="stat-box"><h2>50+</h2><p>Courses</p></div>
        <div class="stat-box"><h2>100k+</h2><p>Learners</p></div>
        <div class="stat-box"><h2>100k+</h2><p>Doubts Solved</p></div>
        <div class="stat-box"><h2>10k+</h2><p>Projects</p></div>
    </section>

    <div class="magical-title-container">
        <h1 class="magical-text">Explore Our Dynamic Classes</h1>
    </div>

    <section class="courses-grid" id="dynamicCoursesGrid"></section>

    <footer class="modern-footer">
        <div class="footer-container">
            <div class="footer-row">
                <div class="footer-col">
                    <h3 id="footerTitle">BBCC Portal</h3>
                    <p id="footerAbout">Shaping the future of students...</p>
                    <div class="social-icons" id="footerSocials"></div>
                </div>
                <div class="footer-col">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href="#" onclick="openPopup()">Portal Login</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h3>Get In Touch</h3>
                    <p id="footerWA"><i class="fab fa-whatsapp"></i> +91 0000000000</p>
                </div>
            </div>
            <div class="footer-bottom">
                <hr>
                <p class="dev-credit">Website Developed by <span>Santosh Sir "Ethical Hacker"</span></p>
            </div>
        </div>
    </footer>

    <script>
        // --- 1. RESULT LOGIC ---
        function openResultPopup() { document.getElementById('resultPopup').style.display = "block"; }
        function closeResultPopup() { 
            document.getElementById('resultPopup').style.display = "none"; 
            document.getElementById('resultContainer').style.display = "none";
        }

        async function searchResult() {
            const roll = document.getElementById('resRoll').value.trim();
            const mob = document.getElementById('resMobile').value.trim();

            if(!roll || !mob) return alert("Enter both ID and Mobile Number");

            try {
                // Fetching from users API
                const res = await fetch('/api/admin/users');
                const users = await res.json();

                const student = users.find(u => (u.username === roll || u._id === roll) && u.mobile === mob);

                if(student) {
                    document.getElementById('stName').innerText = student.fname + " " + student.lname;
                    document.getElementById('stID').innerText = student.username;
                    document.getElementById('stMarks').innerText = student.marks || 'N/A';
                    document.getElementById('stDiv').innerText = student.division || 'N/A';
                    document.getElementById('stPhoto').src = student.profilePhoto || '/assets/default-user.png';
                    document.getElementById('resultContainer').style.display = "block";
                } else {
                    alert("No record found! Please check details.");
                }
            } catch (e) { alert("Error fetching result!"); }
        }

        function downloadJPG() {
            const card = document.getElementById('resultCardCapture');
            html2canvas(card).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Student_Result_BBCC.jpg';
                link.href = canvas.toDataURL("image/jpeg");
                link.click();
            });
        }

        // --- 2. INITIAL DATA LOAD ---
        document.addEventListener('DOMContentLoaded', loadPageData);

        async function loadPageData() {
            try {
                const settingsRes = await fetch('/api/admin/hp-settings');
                if (settingsRes.ok) {
                    const data = await settingsRes.json();
                    if (data.header) {
                        document.getElementById('siteLogo').src = data.header.logo || '/assets/logo.png';
                        document.getElementById('siteTitle').innerText = data.header.title;
                        document.getElementById('siteSubTitle').innerText = data.header.subTitle;
                        document.getElementById('pageTitle').innerText = data.header.title;
                    }
                    if (data.footer) {
                        document.getElementById('footerAbout').innerText = data.footer.about;
                        document.getElementById('footerWA').innerHTML = `<i class="fab fa-whatsapp"></i> ${data.footer.whatsapp}`;
                    }
                }

                const classRes = await fetch('/api/admin/all-classes');
                const classes = await classRes.json();
                const grid = document.getElementById('dynamicCoursesGrid');
                grid.innerHTML = ''; 

                classes.forEach(cls => {
                    const subjectsList = cls.subjects.map(s => s.name).join(", ");
                    const box = document.createElement('div');
                    box.className = 'course-box';
                    box.innerHTML = `
                        <div class="box-front">
                            <img src="${cls.banner || '/assets/default-class.jpg'}" alt="${cls.className}">
                            <h3>${cls.className}</h3>
                        </div>
                        <div class="box-back">
                            <p><strong>Subjects:</strong> ${subjectsList || 'Updating Soon...'}</p>
                            <button class="view-btn" onclick="goToDetails('${cls.className}')">View All Details</button>
                            <button class="enroll-btn" onclick="openPopup()">Enroll Now</button>
                        </div>
                    `;
                    grid.appendChild(box);
                });
            } catch (err) { console.error("Error loading data:", err); }
        }

        function goToDetails(className) {
            window.location.href = `/html/class-details.html?class=${encodeURIComponent(className)}`;
        }

        async function login() {
            const userID = document.getElementById('username').value.trim();
            const userPass = document.getElementById('password').value.trim();
            if (!userID || !userPass) return alert("ðŸš¨ Please enter ID and Password!");

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: userID, password: userPass })
                });
                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('userData', JSON.stringify(data.user));
                    alert(`âœ… Welcome ${data.user.fname}`);
                    window.location.href = data.redirect; 
                } else { alert("âŒ " + data.message); }
            } catch (error) { alert("ðŸ”Œ Server Error!"); }
        }

        let currentSlide = 0;
        setInterval(() => {
            let slides = document.querySelectorAll('.slide');
            if(slides.length === 0) return;
            slides[currentSlide].classList.remove('active');
            currentSlide = (currentSlide + 1) % slides.length;
            slides[currentSlide].classList.add('active');
        }, 3000);

        function openPopup() { document.getElementById('loginPopup').style.display = "block"; }
        function closePopup() { document.getElementById('loginPopup').style.display = "none"; }
    </script>
</body>
</html>
